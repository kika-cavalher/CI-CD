pipeline {
  agent { label 'GI5_SWDCFRNXGI55817' }

  options {
    timestamps()
    disableConcurrentBuilds()
    timeout(time: 8, unit: 'HOURS')
  }

  environment {
    KATALON_HOME      = 'C:\\Users\\adgi5appjenkins\\Documents\\Katalon_Studio_Engine_Windows_64-8.1.0'
    EXECUTION_PROFILE = 'prepevol05'
    BROWSER_TYPE      = 'Chrome'
    PROJECT_FILE      = 'P2P.prj'
  }

  stages {

    stage('Prepare Reports') {
      steps {
        script {
          bat """
            if exist "Reports" rmdir /s /q "Reports"
            mkdir "Reports"
            mkdir "Reports\\_jenkins_summary"
          """
          writeFile file: "Reports\\_jenkins_summary\\build_description.txt", text: ""
        }
      }
    }

    stage('Run Test Suites') {
      steps {
        script {

          def suites = [
            [name: 'LOGIN',                      path: 'Test Suites/LOGIN_GENERIC/login_suite'],
            [name: 'CATALOGS',                   path: 'Test Suites/CATALOGS/catalogs_suite'],
            [name: 'NATIXIS_INVOICES',           path: 'Test Suites/NATIXIS_INVOICES/invoices_suite'],
            [name: 'NATIXIS_LONDON',             path: 'Test Suites/NATIXIS_LONDON/natixis_london_suite'],

            [name: 'NATIXIS_PURCHASE_MODIFY',    path: 'Test Suites/NATIXIS_PURCHASE_ORDER/POs_approver_can_or_not_modify_suite'],
            [name: 'NATIXIS_PURCHASE_CLOSE',     path: 'Test Suites/NATIXIS_PURCHASE_ORDER/POs_approvers_cant_cancel_or_close_suite'],
            [name: 'NATIXIS_PURCHASE_CANCEL',    path: 'Test Suites/NATIXIS_PURCHASE_ORDER/POs_business_support_and_PR_preparer_can_cancel_suite'],
            [name: 'NATIXIS_PURCHASE_CLOSE_ALL', path: 'Test Suites/NATIXIS_PURCHASE_ORDER/POs_business_support_and_PR_preparer_can_close_all_suite'],
            [name: 'NATIXIS_PURCHASE_RECEIPT',   path: 'Test Suites/NATIXIS_PURCHASE_ORDER/POs_receipt_suite'],
            [name: 'NATIXIS_PURCHASE_PERIMETER', path: 'Test Suites/NATIXIS_PURCHASE_ORDER/POs_users_have_access_of_PO_of_own_perimeter_suite'],

            [name: 'NATIXIS_PR',                 path: 'Test Suites/NATIXIS_PURCHASE_REQUEST/PRs_suite'],
            [name: 'NATIXIS_PR_2PHASE',          path: 'Test Suites/NATIXIS_PURCHASE_REQUEST/PRs_2nd_phase_suite'],

            [name: 'NATIXIS_RECEPTION_REC',      path: 'Test Suites/NATIXIS_RECEPTION/receipt_rec_collection_suite'],
            [name: 'NATIXIS_RECEPTION_ETL',      path: 'Test Suites/NATIXIS_RECEPTION/reception_etl_suite'],

            [name: 'TS_COLLECTION_OTHERS',       path: 'Test Suites/TEST_SUITE_COLLECTIONS/without_group'],

            [name: 'BPCE_SI_DAHAT1',             path: 'Test Suites/BPCE_SI/bpce_si_pr_dahat01_suite'],
            [name: 'BPCE_SI_DAHAT2',             path: 'Test Suites/BPCE_SI/bpce_si_pr_dahat02_suite'],
            [name: 'BPCE_SI',                    path: 'Test Suites/BPCE_SI/bpcesi_suite'],

            [name: 'BPCE_ACHATS',                path: 'Test Suites/BPCE_ACHATS/bpce_achats_suite'],
            [name: 'BPCE_ACHATS_GS_BANK_INFO',   path: 'Test Suites/BPCE_ACHATS/bpce_goldenSource_bankingInfo'],

            [name: 'OPS_ACCEPT_TERMS',           path: 'Test Suites/OPS_AUTOMATION/accept_terms_suite'],
            [name: 'OPS_AFTER_REFRESH',          path: 'Test Suites/OPS_AUTOMATION/afterRefreshEnvoirment']
          ]

          def projectPath = "${env.WORKSPACE}\\${env.PROJECT_FILE}"

          for (def s : suites) {

            stage("Suite ${s.name}") {

              def reportDir = "${env.WORKSPACE}\\Reports\\${s.name}\\${env.BUILD_NUMBER}"
              bat "if not exist \"${reportDir}\" mkdir \"${reportDir}\""

              def lockDir        = "C:\\JenkinsLocks"
              def lockFile       = "${lockDir}\\KATALON_ONE_AT_A_TIME_${env.NODE_NAME}.lock"
              def staleLockHours = 12

              def katalonThrew = false
              def katalonErr250 = ""

              catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                try {
                  timeout(time: 110, unit: 'MINUTES') {

                    // Lock (one Katalon at a time) + stale lock recovery
                    powershell """
                      \$ErrorActionPreference = 'Stop'
                      if (!(Test-Path '${lockDir}')) { New-Item -ItemType Directory -Path '${lockDir}' | Out-Null }

                      if (Test-Path '${lockFile}') {
                        try {
                          \$ageHours = ((Get-Date) - (Get-Item '${lockFile}').LastWriteTime).TotalHours
                          if (\$ageHours -gt ${staleLockHours}) { Remove-Item -Force '${lockFile}' }
                        } catch {}
                      }

                      \$acquired = \$false
                      while (-not \$acquired) {
                        try {
                          \$fs = [System.IO.File]::Open('${lockFile}', 'OpenOrCreate', 'ReadWrite', 'None')
                          \$writer = New-Object System.IO.StreamWriter(\$fs)
                          \$writer.WriteLine("JOB=${env.JOB_NAME}")
                          \$writer.WriteLine("BUILD=${env.BUILD_NUMBER}")
                          \$writer.WriteLine("NODE=${env.NODE_NAME}")
                          \$writer.WriteLine("SUITE=${s.name}")
                          \$writer.WriteLine("TIME=" + (Get-Date).ToString("s"))
                          \$writer.Flush()
                          \$acquired = \$true
                        } catch {
                          Start-Sleep -Seconds 5
                        }
                      }
                    """

                    // Pre-clean: only processes tied to THIS project
                    powershell """
                      \$ErrorActionPreference = 'SilentlyContinue'
                      \$proj = '${projectPath}'
                      \$all  = Get-CimInstance Win32_Process

                      \$katalon = \$all | Where-Object {
                        (\$_.Name -match 'katalon|katalonc|java') -and (\$_.CommandLine -like "*\$proj*")
                      }
                      \$katalonPids = @(\$katalon | Select-Object -ExpandProperty ProcessId)

                      \$drivers = \$all | Where-Object {
                        (\$_.Name -in @('chromedriver.exe','msedgedriver.exe','geckodriver.exe')) -and (\$katalonPids -contains \$_.ParentProcessId)
                      }
                      \$driverPids = @(\$drivers | Select-Object -ExpandProperty ProcessId)

                      \$browsers = \$all | Where-Object {
                        (\$_.Name -in @('chrome.exe','msedge.exe','firefox.exe')) -and (
                          (\$katalonPids -contains \$_.ParentProcessId) -or (\$driverPids -contains \$_.ParentProcessId)
                        )
                      }

                      if (\$browsers) { \$browsers | ForEach-Object { try { Stop-Process -Id \$_.ProcessId -Force } catch {} } }
                      if (\$drivers)  { \$drivers  | ForEach-Object { try { Stop-Process -Id \$_.ProcessId -Force } catch {} } }
                      if (\$katalon)  { \$katalon  | ForEach-Object { try { Stop-Process -Id \$_.ProcessId -Force } catch {} } }
                    """

                    // Run Katalon
                    try {
                      executeKatalon(
                        location: "${env.KATALON_HOME}",
                        executeArgs:
                          "-projectPath=\"${projectPath}\" " +
                          "-executionProfile=\"${env.EXECUTION_PROFILE}\" " +
                          "-browserType=\"${env.BROWSER_TYPE}\" " +
                          "-testSuitePath=\"${s.path}\" " +
                          "-consoleLog " +
                          "-reportFolder=\"${reportDir}\" " +
                          "-reportFileName=\"${s.name}\"",
                        version: '',
                        x11Display: '',
                        xvfbConfiguration: ''
                      )
                    } catch (err) {
                      katalonThrew = true
                      def raw = "${err}".replace("\r", "\n")
                      def one = raw.split("\n")[0]?.trim()
                      if (one == null) one = raw
                      one = one.replaceAll("\\s+", " ").trim()
                      if (one.length() > 250) one = one.substring(0, 250)
                      katalonErr250 = one
                    }

                  }
                } finally {

                  // Suite summary from JUnit XML (PowerShell only)
                  def threwVal = katalonThrew ? "1" : "0"
                  def errVal   = (katalonErr250 ?: "").replace("'", "''")

                  powershell """
                    \$ErrorActionPreference = 'SilentlyContinue'

                    \$reportDir  = '${reportDir}'
                    \$suiteName  = '${s.name}'
                    \$threw      = ${threwVal}
                    \$fallback   = '${errVal}'
                    \$globalFile = '${env.WORKSPACE}\\\\Reports\\\\_jenkins_summary\\\\build_description.txt'

                    function ShortN([string]\$x, [int]\$n) {
                      if ([string]::IsNullOrWhiteSpace(\$x)) { return "" }
                      \$t = (\$x -replace '\\s+', ' ').Trim()
                      if (\$t.Length -gt \$n) { return \$t.Substring(0,\$n) }
                      return \$t
                    }

                    if (!(Test-Path (Split-Path \$globalFile))) {
                      New-Item -ItemType Directory -Path (Split-Path \$globalFile) -Force | Out-Null
                    }

                    \$xmlFiles = Get-ChildItem -Path \$reportDir -Recurse -Filter '*.xml' -ErrorAction SilentlyContinue

                    \$cases = @()
                    \$firstFail = ""

                    foreach (\$f in \$xmlFiles) {
                      try { [xml]\$x = Get-Content -Raw -Path \$f.FullName } catch { continue }

                      \$tcs = \$x.SelectNodes('//testcase')
                      if (\$tcs -eq \$null) { continue }

                      foreach (\$tc in \$tcs) {
                        \$cn = [string]\$tc.classname
                        \$nm = [string]\$tc.name

                        \$disp = ""
                        if (\$cn -like 'Test Cases/*') { \$disp = \$cn }
                        elseif (\$nm -like 'Test Cases/*') { \$disp = \$nm }
                        elseif (![string]::IsNullOrWhiteSpace(\$cn) -and ![string]::IsNullOrWhiteSpace(\$nm)) { \$disp = "\$cn - \$nm" }
                        elseif (![string]::IsNullOrWhiteSpace(\$nm)) { \$disp = \$nm }
                        else { \$disp = \$cn }

                        \$isSkipped = (\$tc.skipped -ne \$null)
                        \$isFailed  = (\$tc.failure -ne \$null) -or (\$tc.error -ne \$null)

                        \$status = "PASSED"
                        if (\$isSkipped) { \$status = "SKIPPED" }
                        if (\$isFailed)  { \$status = "FAILED" }

                        \$msg = ""
                        if (\$status -eq "FAILED") {
                          if (\$tc.failure -ne \$null) {
                            \$msg = [string]\$tc.failure.message
                            if ([string]::IsNullOrWhiteSpace(\$msg)) { \$msg = [string]\$tc.failure.'#text' }
                          } elseif (\$tc.error -ne \$null) {
                            \$msg = [string]\$tc.error.message
                            if ([string]::IsNullOrWhiteSpace(\$msg)) { \$msg = [string]\$tc.error.'#text' }
                          }
                          \$msg = ShortN \$msg 250
                          if ([string]::IsNullOrWhiteSpace(\$firstFail) -and ![string]::IsNullOrWhiteSpace(\$msg)) { \$firstFail = \$msg }
                        }

                        \$cases += [pscustomobject]@{ name=\$disp; status=\$status; msg=\$msg }
                      }
                    }

                    \$hasJUnit = (\$cases.Count -gt 0)
                    \$hasFail  = (\$cases | Where-Object { \$_.status -eq 'FAILED' } | Measure-Object).Count -gt 0

                    \$suiteStatus = "PASSED"
                    if (\$hasJUnit) {
                      if (\$hasFail) { \$suiteStatus = "FAILED" }
                    } else {
                      if (\$threw -eq 1) { \$suiteStatus = "FAILED" }
                    }

                    \$suiteMark = if (\$suiteStatus -eq "PASSED") { "OK" } else { "X" }

                    \$lines = New-Object System.Collections.Generic.List[string]
                    \$lines.Add("\$suiteMark \$suiteName")

                    if (\$hasJUnit) {
                      foreach (\$c in \$cases) {
                        \$tcMark = "OK"
                        if (\$c.status -eq "SKIPPED") { \$tcMark = "SKIP" }
                        if (\$c.status -eq "FAILED")  { \$tcMark = "X" }

                        \$lines.Add("       \$tcMark \$([string]\$c.name)")

                        if (\$c.status -eq "FAILED") {
                          \$m = ""
                          if (![string]::IsNullOrWhiteSpace(\$c.msg)) { \$m = \$c.msg }
                          elseif (![string]::IsNullOrWhiteSpace(\$firstFail)) { \$m = \$firstFail }
                          elseif (![string]::IsNullOrWhiteSpace(\$fallback)) { \$m = \$fallback }
                          else { \$m = "Failure" }

                          \$lines.Add("       FAIL: \$m")
                          \$lines.Add("")
                        }
                      }
                      \$lines.Add("")
                    } else {
                      if (\$suiteStatus -eq "FAILED") {
                        \$m = if (![string]::IsNullOrWhiteSpace(\$fallback)) { \$fallback } else { "No JUnit test cases found" }
                        \$lines.Add("       X No JUnit test cases found")
                        \$lines.Add("       FAIL: \$m")
                        \$lines.Add("")
                      } else {
                        \$lines.Add("       OK No JUnit test cases found")
                        \$lines.Add("")
                      }
                    }

                    Add-Content -Path \$globalFile -Value (\$lines -join \"`n\")
                  """

                  // Always release lock
                  powershell """
                    \$ErrorActionPreference = 'SilentlyContinue'
                    \$lockFile = "C:\\JenkinsLocks\\KATALON_ONE_AT_A_TIME_${env.NODE_NAME}.lock"
                    try { if (Test-Path \$lockFile) { Remove-Item -Force \$lockFile } } catch {}
                  """
                }
              }
            }
          }
        }
      }
    }
  }

  post {
    always {
      script {
        def txt = ""
        try {
          txt = readFile("Reports\\_jenkins_summary\\build_description.txt")
        } catch (ignore) {
          txt = "X No summary file generated"
        }

        def esc = txt.replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;")
        currentBuild.description = "<pre style='margin:0; white-space:pre-wrap;'>" + esc + "</pre>"
      }

      echo "Pipeline completed"

      archiveArtifacts artifacts: "Reports/**/${env.BUILD_NUMBER}/**/*", allowEmptyArchive: true

      catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
        junit allowEmptyResults: true, testResults: "Reports/**/${env.BUILD_NUMBER}/**/*.xml"
      }
    }
  }
}
