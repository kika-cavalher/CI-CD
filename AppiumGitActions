name: Run Robot Mobile Suites

on:
  push:
    branches: ["main", "signinTests"]
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  robot-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [evio, wl]
    env:
      PYTHONDONTWRITEBYTECODE: 1
      PABOT_PROCESSES: 1
      EVIO_SUITES: >-
        tests/MOBILE/EVIO/signin.robot
        tests/MOBILE/EVIO/signup.robot
      WL_SUITES: >-
        tests/MOBILE/WL_ACP/signup.robot
        tests/MOBILE/WL_ACP/signin.robot
        
    name: Robot Mobile - Shard ${{ matrix.shard }}
    steps:
      - name: üß∞ Checkout repository
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: pip

      - name: üì¶ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install robotframework-pabot robotframework-appiumlibrary python-dotenv requests

      - name: ‚òï Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: "17"

      - name: üì± Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: üîì Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: üß™ Set up Node.js + Appium
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: üì• Install Appium + driver
        run: |
          npm i -g appium
          appium driver install uiautomator2

      - name: üöÄ Start Appium server
        run: |
          nohup appium --address 127.0.0.1 --port 4723 --relaxed-security --base-path /wd/hub > appium.log 2>&1 &

      - name: ‚è≥ Wait for Appium
        run: |
          timeout 60s bash -c 'until curl -sSf http://127.0.0.1:4723/wd/hub/status > /dev/null; do sleep 2; done'

      - name: üìã Capture ADB log
        run: |
          nohup adb logcat | grep -vE "gfxstream|glDeleteSync|error null ctx" > adb-logcat.log &

      - name: ü§ñ Run suites for ${{ matrix.shard }}
        uses: reactivecircus/android-emulator-runner@v2
        env:
          SHARD: ${{ matrix.shard }}
          SUITES: ${{ matrix.shard == 'evio' && env.EVIO_SUITES || env.WL_SUITES }}
          PABOT_PROCESSES: ${{ env.PABOT_PROCESSES }}
        with:
          api-level: 30
          target: google_apis
          arch: x86_64
          profile: Nexus 5
          ram-size: 4096
          disable-animations: true
          emulator-boot-timeout: 600
          emulator-options: -no-window -gpu off -noaudio -no-boot-anim -memory 4096 -cores 4
          script: |
            set -e
            timeout 180s bash -c 'until adb shell getprop sys.boot_completed | grep -m1 1; do sleep 2; done'
            timeout 60s bash -c 'until adb devices | grep -m1 "device$"; do sleep 2; done'
            sleep 45
            mkdir -p .log
            for SUITE in $SUITES; do SUITE_NAME=$(basename "$SUITE" .robot); OUTDIR=".log/${SHARD}_${SUITE_NAME}"; mkdir -p "$OUTDIR"; pabot --processes ${PABOT_PROCESSES} --testlevelsplit --variable uiautomator2ServerInstallTimeout:60000 -d "$OUTDIR" "$SUITE" || echo "‚ùå Robot failed for ${SUITE_NAME}"; (cd .log && zip -qr "${SHARD}_${SUITE_NAME}.zip" "${SHARD}_${SUITE_NAME}" || true); done

      - name: üìä Build summary for ${{ matrix.shard }}
        if: always()
        env:
          SHARD: ${{ matrix.shard }}
        shell: python
        run: |
          import os, xml.etree.ElementTree as ET, textwrap
          from datetime import datetime, timezone
          shard = os.environ.get("SHARD", "X")
          client = {"evio":"EVIO","wl":"WL_ACP"}.get(shard, shard.upper())
          base = ".log"
          total_passed = total_failed = 0
          sections = []
          def short_reason(text, limit=180):
              if not text: return "(no failure message found)"
              lines = [l.strip() for l in text.strip().splitlines() if l.strip()]
              for l in lines:
                  if "Timed out after" in l and "AccessibilityNodeInfo" in l:
                      return "‚ùå Device froze during camera capture"
                  if any(k in l for k in ("Element locator","AssertionError","Timeout")):
                      return (l[:limit]+"‚Ä¶") if len(l)>limit else l
              return (lines[0][:limit]+"‚Ä¶") if lines else "(no message)"
          def first_log_lines(text, max_lines=3):
              if not text: return "  (no log found)"
              lines = [l for l in text.strip().splitlines() if l.strip()]
              return "\n".join([f"  {line}" for line in lines[:max_lines]])
          for entry in sorted(os.listdir(base)):
              if not entry.startswith(f"{shard}_"): 
                  continue
              xml_path = os.path.join(base, entry, "output.xml")
              if not os.path.isfile(xml_path):
                  continue
              suite_name = entry.split("_",1)[1].upper()
              try:
                  root = ET.parse(xml_path).getroot()
              except ET.ParseError:
                  sections.append(f"üì¶ Suite: {suite_name}\n- ‚ùå Could not parse output.xml")
                  continue
              passed, failed = [], []
              for t in root.iter("test"):
                  tname = t.get("name")
                  status_el = t.find("status")
                  status = status_el.get("status") if status_el is not None else "UNKNOWN"
                  if status == "PASS":
                      total_passed += 1
                      passed.append(f"- {tname}: ‚úÖ PASS")
                  else:
                      total_failed += 1
                      reason = short_reason(status_el.text if status_el is not None else "")
                      log_preview = first_log_lines(status_el.text if status_el is not None else "")
                      failed.append(f"- {tname}: ‚ùå FAIL\n  Reason: {reason}\n  üîç Log:\n{log_preview}\n")
              lines = [f"üì¶ Suite: {suite_name}"]
              if passed: lines.append("\n".join(passed))
              if failed:
                  if passed: lines.append("")
                  lines.append("\n".join(failed))
              sections.append("\n".join(lines))
          total = total_passed + total_failed
          overall = "SUCCESS" if total > 0 and total_failed == 0 else "FAILED"
          if total == 0:
              sections.append("- Result: ‚ùå no test outputs generated")
          header = textwrap.dedent(f"""
            üìÖ UTC: {datetime.now(timezone.utc):%Y-%m-%d %H:%M:%S}
            üß© Client: {client}
            üìä Total: {total} | Pass: {total_passed} | Fail: {total_failed}
            üìå Status: {overall}
          """).strip()
          summary = header + "\n\n" + "\n\n".join(sections) + "\n"
          open("summary.txt", "w", encoding="utf-8").write(summary)
          open(os.environ["GITHUB_STEP_SUMMARY"], "a", encoding="utf-8").write(summary)

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        continue-on-error: true
        with:
          name: logs-${{ matrix.shard }}
          path: .log/*.zip
          if-no-files-found: ignore

      - name: üìé Upload reports for ${{ matrix.shard }}
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: robot-artifacts-${{ matrix.shard }}
          path: |
            .log/${{ matrix.shard }}_*.zip
            summary.txt
          if-no-files-found: ignore
          compression-level: 9
          retention-days: 2

      - name: üìß Send e-mail summary for ${{ matrix.shard }}
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.office365.com
          server_port: 587
          secure: false
          username: erica.cavalher@go-evio.com
          password: ${{ secrets.EMAIL_PASSWORD }}
          from: "Robot QA <erica.cavalher@go-evio.com>"
          #to: erica.cavalher@go-evio.com
          to: erica.cavalher@go-evio.com, pedro.ramoa@go-evio.com, diogo.marques@go-evio.com, carlos.almeida@go-evio.com, michel.lang@go-evio.com, armando.machado@go-evio.com
          subject: ${{ format('Mobile Tests | {0} | {1}', fromJSON('{"evio":"EVIO","wl":"WL_ACP"}')[matrix.shard], github.ref_name) }}
          body: file://summary.txt
          attachments: |
            .log/${{ matrix.shard }}_*.zip
