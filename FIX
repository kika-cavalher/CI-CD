import com.kms.katalon.core.annotation.Keyword
import com.kms.katalon.core.windows.driver.WindowsDriverFactory
import org.openqa.selenium.Keys
import java.awt.Toolkit
import java.awt.datatransfer.StringSelection
import java.io.File

public class Common {

    @Keyword
    void importFile(String fullFilePath, int timeoutSec = 20) {

        File f = new File(fullFilePath)
        if (!f.exists()) {
            throw new IllegalArgumentException("File not found: " + fullFilePath)
        }

        def driver = WindowsDriverFactory.getWindowsDriver()

        focusOpenDialog(driver, timeoutSec)

        // Focus "File name" field (Alt+N usually works on Open/Ouvrir/Abrir)
        sendActive(driver, Keys.chord(Keys.ALT, "n"))
        sleepMs(200)

        // Paste full path into File name and confirm
        setClipboard(fullFilePath)
        sendActive(driver, Keys.chord(Keys.CONTROL, "a"))
        sendActive(driver, Keys.chord(Keys.CONTROL, "v"))
        sleepMs(150)
        sendActive(driver, Keys.ENTER)
        sleepMs(400)

        // If a warning pops, just confirm (optional but helps)
        handleWarningIfAny(driver, 2)
    }

    void focusOpenDialog(def driver, int timeoutSec) {
        long end = System.currentTimeMillis() + (timeoutSec * 1000)
        Exception last = null

        while (System.currentTimeMillis() < end) {
            try {
                if (switchToWindowTitleContains(driver, ["Ouvrir", "Open", "Abrir"])) {
                    return
                }
            } catch (Exception e) {
                last = e
            }
            sleepMs(200)
        }

        throw new Exception("Open dialog not found within " + timeoutSec + "s. Last error: " + (last?.getMessage() ?: "n/a"))
    }

    boolean switchToWindowTitleContains(def driver, List<String> candidates) {
        def handles = driver.getWindowHandles()
        for (def h : handles) {
            driver.switchTo().window(h)
            String title = ""
            try { title = driver.getTitle() ?: "" } catch (Exception ignored) {}
            for (def c : candidates) {
                if (title.toLowerCase().contains(c.toLowerCase())) {
                    return true
                }
            }
        }
        return false
    }

    void handleWarningIfAny(def driver, int timeoutSec) {
        long end = System.currentTimeMillis() + (timeoutSec * 1000)
        while (System.currentTimeMillis() < end) {
            if (switchToWindowTitleContains(driver, ["Microsoft", "Warning", "Attention", "Erreur", "Error"])) {
                sendActive(driver, Keys.ENTER)
                sleepMs(200)
                return
            }
            sleepMs(150)
        }
    }

    void sendActive(def driver, Object keysOrText) {
        driver.switchTo().activeElement().sendKeys(keysOrText)
    }

    void setClipboard(String text) {
        Toolkit.getDefaultToolkit().getSystemClipboard().setContents(new StringSelection(text), null)
    }

    void sleepMs(long ms) {
        try { Thread.sleep(ms) } catch (Exception ignored) {}
    }
}
