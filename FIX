import com.kms.katalon.core.windows.driver.WindowsDriverFactory
import com.kms.katalon.core.windows.keyword.WindowsBuiltinKeywords as Windows
import org.openqa.selenium.Keys

void importFile(String fullFilePath, int timeoutSec = 20) {

    File f = new File(fullFilePath)
    String folderPath = f.getParent()
    String fileNameOnly = f.getName()

    if (!folderPath || !fileNameOnly) {
        throw new IllegalArgumentException("Invalid path: " + fullFilePath)
    }

    focusOpenDialog(timeoutSec)

    def driver = WindowsDriverFactory.getWindowsDriver()

    sendActive(driver, Keys.chord(Keys.CONTROL, "l"))
    Windows.delay(0.2)

    sendActive(driver, folderPath)
    Windows.delay(0.2)

    sendActive(driver, Keys.ENTER)
    Windows.delay(0.8)

    focusFileNameField(driver, timeoutSec)

    sendActive(driver, Keys.chord(Keys.CONTROL, "a"))
    Windows.delay(0.1)
    sendActive(driver, Keys.DELETE)
    Windows.delay(0.1)

    sendActive(driver, fileNameOnly)
    Windows.delay(0.2)

    sendActive(driver, Keys.ENTER)
    Windows.delay(0.8)
}

void focusOpenDialog(int timeoutSec = 20) {

    long end = System.currentTimeMillis() + (timeoutSec * 1000)
    Exception last = null

    while (System.currentTimeMillis() < end) {
        try { Windows.switchToWindowTitle("Ouvrir"); return } catch (Exception e) { last = e }
        try { Windows.switchToWindowTitle("Open");   return } catch (Exception e) { last = e }
        try { Windows.switchToWindowTitle("Abrir");  return } catch (Exception e) { last = e }
        Windows.delay(0.2)
    }

    throw new Exception("Open dialog not found. Last error: " + (last?.getMessage() ?: "n/a"))
}

void focusFileNameField(def driver, int timeoutSec = 20) {

    long end = System.currentTimeMillis() + (timeoutSec * 1000)

    while (System.currentTimeMillis() < end) {
        def el = driver.switchTo().activeElement()

        String className = safeAttr(el, "ClassName")
        String autoId = safeAttr(el, "AutomationId")

        if ("Edit".equalsIgnoreCase(className) && "1148".equals(autoId)) {
            return
        }

        sendActive(driver, Keys.TAB)
        Windows.delay(0.15)
    }

    throw new Exception("File name field not reached within timeout.")
}

void sendActive(def driver, Object keysOrText) {
    driver.switchTo().activeElement().sendKeys(keysOrText)
}

String safeAttr(def el, String name) {
    try { return el.getAttribute(name) } catch (Exception ignored) { return "" }
}
