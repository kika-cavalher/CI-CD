package general

import com.kms.katalon.core.annotation.Keyword
import com.kms.katalon.core.windows.driver.WindowsDriverFactory
import org.openqa.selenium.Keys

import java.awt.Toolkit
import java.awt.datatransfer.StringSelection
import java.io.File

class Common {

    @Keyword
    void importFile(String fullFilePath, int timeoutSec = 20) {

        File f = new File(fullFilePath)
        if (!f.exists()) {
            throw new IllegalArgumentException("File not found: " + fullFilePath)
        }

        def driver = WindowsDriverFactory.getWindowsDriver()

        focusOpenDialog(driver, timeoutSec)

        // Vai direto pro "File name" (no teu modal FR aparece como "File name:" embaixo)
        sendActive(driver, Keys.chord(Keys.ALT, "n"))
        sleepMs(150)

        // Cola o caminho completo e confirma
        setClipboard(fullFilePath)
        sendActive(driver, Keys.chord(Keys.CONTROL, "a"))
        sendActive(driver, Keys.chord(Keys.CONTROL, "v"))
        sleepMs(150)
        sendActive(driver, Keys.ENTER)
        sleepMs(300)

        // Se aparecer warning, confirma com Enter
        handleWarningIfAnyux(driver, 2)
    }

    void focusOpenDialog(def driver, int timeoutSec) {
        long end = System.currentTimeMillis() + (timeoutSec * 1000)

        while (System.currentTimeMillis() < end) {
            if (switchToWindowTitleContains(driver, ["Ouvrir", "Open", "Abrir"])) {
                return
            }
            sleepMs(200)
        }

        throw new Exception("Open dialog not found within " + timeoutSec + "s")
    }

    boolean switchToWindowTitleContains(def driver, List<String> candidates) {
        def handles = driver.getWindowHandles()
        for (def h : handles) {
            driver.switchTo().window(h)

            String title = ""
            try { title = driver.getTitle() ?: "" } catch (Exception ignored) {}

            for (String c : candidates) {
                if (title.toLowerCase().contains(c.toLowerCase())) {
                    return true
                }
            }
        }
        return false
    }

    void handleWarningIfux(def driver, int timeoutSec) {
        long end = System.currentTimeMillis() + (timeoutSec * 1000)

        while (System.currentTimeMillis() < end) {
            if (switchToWindowTitleContains(driver, ["Warning", "Attention", "Erreur", "Error", "Microsoft"])) {
                sendActive(driver, Keys.ENTER)
                sleepMs(200)
                return
            }
            sleepMs(150)
        }
    }

    void sendActive(def driver, Object keysOrText) {
        driver.switchTo().activeElement().sendKeys(keysOrText)
    }

    void setClipboard(String text) {
        Toolkit.getDefaultToolkit().getSystemClipboard().setContents(new StringSelection(text), null)
    }

    void sleepMs(long ms) {
        try { Thread.sleep(ms) } catch (Exception ignored) {}
    }
}
