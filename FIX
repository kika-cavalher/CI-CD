import java.io.File
import org.openqa.selenium.Keys
import com.kms.katalon.core.testobject.WindowsTestObject
import com.kms.katalon.core.testobject.ConditionType
import com.kms.katalon.core.windows.keyword.WindowsBuiltinKeywords as Windows

void importFile(String fullFilePath, int timeoutSec = 15) {

    File f = new File(fullFilePath)
    String folderPath = f.getParent()
    String fileNameOnly = f.getName()

    if (!folderPath || !fileNameOnly) {
        throw new IllegalArgumentException("Invalid path: " + fullFilePath)
    }

    focusOpenDialog(timeoutSec)

    WindowsTestObject dlg = new WindowsTestObject("dlg")
    dlg.addProperty("xpath", ConditionType.EQUALS, "//*[@ClassName='#32770']")

    send(dlg, Keys.chord(Keys.CONTROL, "l"))
    Windows.delay(0.2)

    send(dlg, folderPath)
    Windows.delay(0.2)

    send(dlg, Keys.ENTER)
    Windows.delay(0.8)

    send(dlg, Keys.TAB)
    Windows.delay(0.1)
    send(dlg, Keys.TAB)
    Windows.delay(0.1)

    send(dlg, fileNameOnly)
    Windows.delay(0.2)

    send(dlg, Keys.ENTER)
    Windows.delay(0.6)
}

void focusOpenDialog(int timeoutSec = 15) {
    long end = System.currentTimeMillis() + (timeoutSec * 1000)
    Exception last = null

    while (System.currentTimeMillis() < end) {
        try { Windows.switchToWindowTitle("Ouvrir"); return } catch (Exception e) { last = e }
        try { Windows.switchToWindowTitle("Open");  return } catch (Exception e) { last = e }
        try { Windows.switchToWindowTitle("Abrir"); return } catch (Exception e) { last = e }
        Windows.delay(0.2)
    }

    throw new Exception("Open dialog not found. Last error: " + (last?.getMessage() ?: "n/a"))
}

void send(WindowsTestObject target, Object keyOrText) {
    Windows.sendKeys(target, [keyOrText] as CharSequence[])
}
