import java.awt.Robot
import java.awt.Toolkit
import java.awt.datatransfer.StringSelection
import java.awt.event.KeyEvent
import java.io.File

import com.katalon.keywords.windows.WindowsImageKeywords
import com.kms.katalon.core.windows.keyword.WindowsBuiltinKeywords as Windows

void importFile(String pathOrFolder) {

    Export export = new Export()
    Robot r = new Robot()

    File p = new File(pathOrFolder)

    // Se vier só a pasta, usa o ficheiro default
    String folderPath   = p.isDirectory() ? p.getAbsolutePath() : p.getParent()
    String fileNameOnly = p.isDirectory() ? "PasserelleBilan.xlsx" : p.getName()

    // Clipboard com a pasta (o teu Ctrl+V já funciona bem aqui)
    Toolkit.getDefaultToolkit().getSystemClipboard()
        .setContents(new StringSelection(folderPath), null)

    Windows.delay(1)

    // 1) Clica no campo do path e cola a pasta
    WindowsImageKeywords.clickImage(images.fileTopDialog)
    Windows.delay(0.2)
    export.simulateCtrlV()
    Windows.delay(0.2)

    // 2) Enter para entrar na pasta
    tap(r, KeyEvent.VK_ENTER)
    Windows.delay(1.2)

    // 3) Tab x2
    tap(r, KeyEvent.VK_TAB)
    Windows.delay(0.2)
    tap(r, KeyEvent.VK_TAB)
    Windows.delay(0.2)

    // 4) Alt+N para ir ao File name
    chord(r, KeyEvent.VK_ALT, KeyEvent.VK_N)
    Windows.delay(0.2)

    // 5) Ctrl+A e digita o nome do ficheiro
    chord(r, KeyEvent.VK_CONTROL, KeyEvent.VK_A)
    Windows.delay(0.1)
    typeFilename(r, fileNameOnly)
    Windows.delay(0.2)

    // 6) Enter para abrir
    tap(r, KeyEvent.VK_ENTER)
    Windows.delay(0.6)
}

void tap(Robot r, int key) {
    r.keyPress(key)
    r.keyRelease(key)
}

void chord(Robot r, int mod, int key) {
    r.keyPress(mod)
    r.keyPress(key)
    r.keyRelease(key)
    r.keyRelease(mod)
}

// Suporta nome tipo PasserelleBilan.xlsx
void typeFilename(Robot r, String text) {
    for (char c : text.toCharArray()) {

        if (c == '.') { tap(r, KeyEvent.VK_PERIOD); continue }
        if (c == '-') { tap(r, KeyEvent.VK_MINUS); continue }
        if (c == '_') { chord(r, KeyEvent.VK_SHIFT, KeyEvent.VK_MINUS); continue }

        int code = KeyEvent.getExtendedKeyCodeForChar((int)c)
        if (code <= 0 || code == KeyEvent.VK_UNDEFINED) {
            throw new IllegalArgumentException("Unsupported char in filename: [" + c + "]")
        }

        boolean shift = Character.isUpperCase(c)
        if (shift) r.keyPress(KeyEvent.VK_SHIFT)
        r.keyPress(code)
        r.keyRelease(code)
        if (shift) r.keyRelease(KeyEvent.VK_SHIFT)

        try { Thread.sleep(10) } catch(Exception ignored) {}
    }
}
