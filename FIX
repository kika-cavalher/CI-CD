import java.awt.Robot
import java.awt.Toolkit
import java.awt.datatransfer.StringSelection
import java.awt.event.KeyEvent
import java.io.File

import com.katalon.keywords.windows.WindowsImageKeywords
import com.kms.katalon.core.windows.keyword.WindowsBuiltinKeywords as Windows

void importFile(String pathOrFile) {

    Export export = new Export()
    Robot r = new Robot()

    File p = new File(pathOrFile)

    // ✅ If they pass only the folder, use the default file name
    String folderPath = p.isDirectory() ? p.getAbsolutePath() : p.getParent()
    String fileNameOnly = p.isDirectory() ? "PasserelleBilan.xlsx" : p.getName()

    // ✅ Clipboard contains ONLY the folder path (because your paste already works)
    Toolkit.getDefaultToolkit().getSystemClipboard()
        .setContents(new StringSelection(folderPath), null)

    Windows.delay(1)

    // ✅ Click the path/address field (your image works here)
    WindowsImageKeywords.clickImage(images.fileTopDialog)
    Windows.delay(0.2)

    // ✅ Paste folder path (your existing way)
    export.simulateCtrlV()
    Windows.delay(0.3)

    // ✅ Enter to navigate to the folder
    tap(r, KeyEvent.VK_ENTER)
    Windows.delay(1.2)

    // ✅ Tab x2 (your manual flow)
    tap(r, KeyEvent.VK_TAB)
    Windows.delay(0.2)
    tap(r, KeyEvent.VK_TAB)
    Windows.delay(0.2)

    // ✅ Alt+N to focus File name (you confirmed this works after 2 tabs)
    chord(r, KeyEvent.VK_ALT, KeyEvent.VK_N)
    Windows.delay(0.2)

    // ✅ Type file name (NO Windows.sendKeys, NO Ctrl+V)
    chord(r, KeyEvent.VK_CONTROL, KeyEvent.VK_A)
    Windows.delay(0.1)
    typeTextSimple(r, fileNameOnly)
    Windows.delay(0.2)

    // ✅ Enter to open the file
    tap(r, KeyEvent.VK_ENTER)
    Windows.delay(0.6)
}

void tap(Robot r, int key) {
    r.keyPress(key)
    r.keyRelease(key)
}

void chord(Robot r, int mod, int key) {
    r.keyPress(mod)
    r.keyPress(key)
    r.keyRelease(key)
    r.keyRelease(mod)
}

// ✅ Supports letters, numbers, dot, dash, underscore
void typeTextSimple(Robot r, String text) {
    for (char c : text.toCharArray()) {
        if (c == '.') { tap(r, KeyEvent.VK_PERIOD); continue }
        if (c == '-') { tap(r, KeyEvent.VK_MINUS); continue }
        if (c == '_') { chord(r, KeyEvent.VK_SHIFT, KeyEvent.VK_MINUS); continue }

        int code = KeyEvent.getExtendedKeyCodeForChar((int)c)
        if (code <= 0 || code == KeyEvent.VK_UNDEFINED) {
            throw new IllegalArgumentException("Unsupported char in filename: [" + c + "]")
        }

        boolean shift = Character.isUpperCase(c)
        if (shift) r.keyPress(KeyEvent.VK_SHIFT)
        r.keyPress(code)
        r.keyRelease(code)
        if (shift) r.keyRelease(KeyEvent.VK_SHIFT)
    }
}
