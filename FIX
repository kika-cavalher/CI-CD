package general

import com.kms.katalon.core.annotation.Keyword
import com.kms.katalon.core.testobject.ConditionType
import com.kms.katalon.core.testobject.WindowsTestObject
import com.kms.katalon.core.windows.keyword.WindowsBuiltinKeywords as Windows
import org.openqa.selenium.Keys

import java.io.File

public class Common {

	@Keyword
	void importFile(String fullFilePath, int timeoutSec = 20) {

		File f = new File(fullFilePath)
		String folderPath = f.getParent()
		String fileNameOnly = f.getName()

		if (!folderPath || !fileNameOnly) {
			throw new IllegalArgumentException("Invalid path: " + fullFilePath)
		}

		String title = focusOpenDialog(timeoutSec)

		WindowsTestObject dlg = new WindowsTestObject("openDialog")
		dlg.addProperty("xpath", ConditionType.EQUALS, "//*[@ClassName='#32770' and @Name='" + title + "']")

		send(dlg, Keys.chord(Keys.CONTROL, "l"))
		Windows.delay(0.2)

		send(dlg, folderPath)
		Windows.delay(0.2)

		send(dlg, Keys.ENTER)
		Windows.delay(0.8)

		send(dlg, Keys.TAB)
		Windows.delay(0.1)
		send(dlg, Keys.TAB)
		Windows.delay(0.1)

		send(dlg, Keys.chord(Keys.CONTROL, "a"))
		Windows.delay(0.1)

		send(dlg, fileNameOnly)
		Windows.delay(0.2)

		send(dlg, Keys.ENTER)
		Windows.delay(0.8)
	}

	String focusOpenDialog(int timeoutSec = 20) {

		long end = System.currentTimeMillis() + (timeoutSec * 1000)
		Exception last = null

		while (System.currentTimeMillis() < end) {
			try { Windows.switchToWindowTitle("Ouvrir"); return "Ouvrir" } catch (Exception e) { last = e }
			try { Windows.switchToWindowTitle("Open");   return "Open"   } catch (Exception e) { last = e }
			try { Windows.switchToWindowTitle("Abrir");  return "Abrir"  } catch (Exception e) { last = e }
			Windows.delay(0.2)
		}

		throw new Exception("Open dialog not found within " + timeoutSec + "s. Last error: " + (last?.getMessage() ?: "n/a"))
	}

	void send(WindowsTestObject target, Object keyOrText) {
		CharSequence cs = (keyOrText instanceof CharSequence) ? (CharSequence) keyOrText : keyOrText.toString()
		Windows.sendKeys(target, [cs] as CharSequence[])
	}
}
