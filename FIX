// ----------------------------
// REQUIRED HELPERS
// ----------------------------

void importFile(String fullFilePath, int timeoutSec = 20) {
    File f = new File(fullFilePath)
    if (!f.exists()) {
        throw new IllegalArgumentException("File not found: " + fullFilePath)
    }

    def driver = WindowsDriverFactory.getWindowsDriver()

    focusOpenDialog(driver, timeoutSec)

    sendActive(driver, Keys.chord(Keys.ALT, "n"))
    sleepMs(200)

    setClipboard(fullFilePath)
    sendActive(driver, Keys.chord(Keys.CONTROL, "a"))
    sendActive(driver, Keys.chord(Keys.CONTROL, "v"))
    sleepMs(150)

    sendActive(driver, Keys.ENTER)
    sleepMs(400)

    handleWarningIfux(driver, 2)
}

void focusOpenDialog(def driver, int timeoutSec) {
    long end = System.currentTimeMillis() + (timeoutSec * 1000)

    while (System.currentTimeMillis() < end) {
        // Try to find the Open dialog by common title fragments across Windows/FR/EN
        if (switchToWindowTitleContains(driver, ["Open", "Ouvrir", "Abrir", "Choose", "Select", "File Upload", "Dialog"])) {
            // Force focus into dialog (helps when Katalon window still has focus)
            sendActive(driver, Keys.ESCAPE)   // harmless, just ensures dialog is active
            sleepMs(120)
            return
        }
        sleepMs(200)
    }

    throw new Exception("Open dialog not found within " + timeoutSec + "s")
}

boolean switchToWindowTitleContains(def driver, List<String> candidates) {
    def handles = driver.getWindowHandles()
    for (def h : handles) {
        driver.switchTo().window(h)

        String title = ""
        try { title = driver.getTitle() ?: "" } catch (Exception ignored) { }

        for (String c : candidates) {
            if (title.toLowerCase().contains(c.toLowerCase())) {
                return true
            }
        }
    }
    return false
}

void handleWarningIfux(def driver, int timeoutSec) {
    long end = System.currentTimeMillis() + (timeoutSec * 1000)

    while (System.currentTimeMillis() < end) {
        if (switchToWindowTitleContains(driver, ["Warning", "Attention", "Erreur", "Error"])) {
            sendActive(driver, Keys.ENTER)
            sleepMs(200)
            return
        }
        sleepMs(150)
    }
}

void sendActive(def driver, Object keysOrText) {
    driver.switchTo().activeElement().sendKeys(keysOrText)
}

void setClipboard(String text) {
    StringSelection stringSelection = new StringSelection(text)
    Toolkit.getDefaultToolkit().getSystemClipboard().setContents(stringSelection, null)
}

void sleepMs(int ms) {
    Thread.sleep(ms)
}
