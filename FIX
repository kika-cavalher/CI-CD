import static com.kms.katalon.core.testobject.ObjectRepository.findTestObject
import com.kms.katalon.core.testobject.testobject
import java.text.SimpleDateFormat
import com.kms.katalon.core.annotation.Keyword
import com.kms.katalon.core.model.FailureHandling
import com.kms.katalon.core.testobject.ConditionType
import com.kms.katalon.core.util.KeywordUtil
import com.kms.katalon.core.webui.keyword.WebUiBuiltInKeywords as WebUI
import java.time.LocalDate
import internal.GlobalVariable
import invoiceKeywords.InvoiceImporter
import invoiceKeywords.InvoiceManager
import loginKeywords.LoginActions
import loginKeywords.LoginConstants
import pagesFLow.GlobalKeywords
import utils.Steps
import utils.UIActions

import java.time.format.DateTimeFormatter

String orderItem = 'PO034599'
String invoiceCode = 'tc_INV_14_01' 


Map<String, String> paths = InvoiceManager.generateUniqueCsv(invoiceCode, 'f7383d1b-7b69-466c-9611-b1c300938554.pdf') 
String importCsvPath = paths.csvPath
String importPdfPath = paths.pdfPath

// ================================
// Admin user: import invoice files
// ================================
Steps.note('Login as Group Admin')
LoginActions.loginUser(LoginConstants.CREDENTIALS_DATA_SHEET, 32)
WebUI.navigateToUrl(GlobalVariable.HOMEPAGE_URL)

//Go to Browse Invoices, search for invoice "TC_INV_14_01" , and click "Submit"
Steps.note("Open Configure ETL and create new import for 'natixis_invoice_' using TC_INV_14_01.zip (CSV+PDF)")
InvoiceImporter.importInvoiceFiles(importCsvPath, importPdfPath)
UIActions.waitForPageToBeReady(3)

// Open Browse Invoices
Steps.note('Navigate to Invoicing > Browse Invoices')
GlobalKeywords.NavegateToPageWithMenu('menu_harmoni/buttonInvoicing', 'menu_harmoni/responsive/buttonInvoicing','menu_harmoni/invoicing/buttonBrowseInvoices', 'menu_harmoni/responsive/buttonBrowseInvoices')
WebUI.delay(5)

// Open Invoice by ID
String stamp = GlobalVariable.CONVERTED_DATE   // ex: 20260108_145141  OR  20260108
String expected = "${invoiceCode}_${stamp}"

TestObject rowCodeLink = new TestObject('rowCodeLink')
rowCodeLink.addProperty('xpath', ConditionType.EQUALS,
  "//table//a[.//span[contains(normalize-space(.), '${expected}')]]"
)

WebUI.waitForElementClickable(rowCodeLink, 30)
WebUI.click(rowCodeLink)

// Validate Linked PO
String actualPOID = WebUI.getText(findTestObject('POC_ETL/text_POID'))
if (actualPOID.contains(GlobalVariable.idPR)) {
    KeywordUtil.markPassed("✅ Invoice is correctly linked to PO: ${actualPOID}")
} else {
    KeywordUtil.markFailedAndStop("❌ Invoice PO does not match expected PO: ${GlobalVariable.idPR}")
}

// Submit and Confirm Alert
UIActions.click('POC_ETL/buttonSubmit')
WebUI.acceptAlert()

// Open Workflow and Verify Launch Button
UIActions.click('POC_ETL/buttonWorkFlow')
boolean launchButtonVisible = WebUI.verifyElementPresent(
        findTestObject('POC_ETL/workflow_LaunchPaymentProcess'),
        5,
        FailureHandling.OPTIONAL
)
