import com.kms.katalon.core.windows.keyword.WindowsBuiltinKeywords as Windows
import com.kms.katalon.core.testobject.WindowsTestObject
import com.kms.katalon.core.testobject.ConditionType
import org.openqa.selenium.Keys

void importFile(String fullFilePath, int timeoutSec = 20) {

    if (!fullFilePath) {
        throw new IllegalArgumentException("fullFilePath is empty")
    }

    File f = new File(fullFilePath)
    String folderPath = f.getParent()
    String fileNameOnly = f.getName()

    if (!folderPath || !fileNameOnly) {
        throw new IllegalArgumentException("Invalid path: " + fullFilePath)
    }

    focusOpenDialog(timeoutSec)

    WindowsTestObject addressBar = new WindowsTestObject("addressBar")
    addressBar.addProperty("xpath", ConditionType.EQUALS,
        "//*[@AutomationId='41477' and @ClassName='Edit']"
    )

    WindowsTestObject fileNameField = new WindowsTestObject("fileNameField")
    fileNameField.addProperty("xpath", ConditionType.EQUALS,
        "//*[@AutomationId='1148' and @ClassName='Edit']"
    )

    Windows.waitForElementPresent(addressBar, 5)
    Windows.click(addressBar)
    Windows.sendKeys(addressBar, [Keys.chord(Keys.CONTROL, "a")] as CharSequence[])
    Windows.sendKeys(addressBar, [Keys.DELETE] as CharSequence[])
    Windows.setText(addressBar, folderPath)
    Windows.sendKeys(addressBar, [Keys.ENTER] as CharSequence[])
    Windows.delay(0.4)

    handleWarningIfAny()

    Windows.waitForElementPresent(fileNameField, 5)
    Windows.click(fileNameField)
    Windows.sendKeys(fileNameField, [Keys.chord(Keys.CONTROL, "a")] as CharSequence[])
    Windows.sendKeys(fileNameField, [Keys.DELETE] as CharSequence[])
    Windows.setText(fileNameField, fileNameOnly)
    Windows.sendKeys(fileNameField, [Keys.ENTER] as CharSequence[])
    Windows.delay(0.4)

    handleWarningIfAny()
}

void focusOpenDialog(int timeoutSec = 20) {

    long end = System.currentTimeMillis() + (timeoutSec * 1000)
    Exception last = null

    while (System.currentTimeMillis() < end) {
        try { Windows.switchToWindowTitle("Ouvrir"); return } catch (Exception e) { last = e }
        try { Windows.switchToWindowTitle("Open");   return } catch (Exception e) { last = e }
        try { Windows.switchToWindowTitle("Abrir");  return } catch (Exception e) { last = e }
        Windows.delay(0.2)
    }

    throw new Exception("Open dialog not found within " + timeoutSec + "s. Last error: " + (last?.getMessage() ?: "n/a"))
}

void handleWarningIfAny() {

    String[] titles = ["Warning", "Avertissement", "Aviso", "Erro", "Error"]

    for (String t : titles) {
        try {
            Windows.switchToWindowTitle(t)

            WindowsTestObject okBtn = new WindowsTestObject("okBtn")
            okBtn.addProperty("xpath", ConditionType.EQUALS,
                "//*[@ClassName='Button' and (@Name='OK' or @Name='Ok' or @Name='O&K')]"
            )

            if (Windows.waitForElementPresent(okBtn, 2)) {
                Windows.click(okBtn)
                throw new Exception("File dialog warning detected: " + t)
            }
        } catch (Exception ignored) {
        }
    }
}
