package general

import static com.kms.katalon.core.testobject.ObjectRepository.findWindowsObject
import java.awt.Robot
import java.awt.Toolkit
import java.awt.datatransfer.StringSelection
import java.awt.event.KeyEvent
import java.nio.file.Files
import java.nio.file.Paths
import java.nio.file.StandardCopyOption
import java.time.LocalDate
import org.openqa.selenium.Keys
import com.katalon.keywords.windows.WindowsImageKeywords
import com.kms.katalon.core.annotation.Keyword
import com.kms.katalon.core.configuration.RunConfiguration
import com.kms.katalon.core.util.KeywordUtil
import com.kms.katalon.core.windows.driver.WindowsDriverFactory
import com.kms.katalon.core.windows.keyword.WindowsBuiltinKeywords as Windows
import com.kms.katalon.core.windows.keyword.helper.WindowsActionHelper

import internal.GlobalVariable


public class Common {
	ImageLoader imageLoader = new ImageLoader()

	Map<String, String> images = imageLoader.loadImagesGeneral()

	Map<String, String> imagesPassarele = imageLoader.loadImagePassarele()

	Robot robot = new Robot()

	@Keyword
	String getArreteDate() {
		def a = Windows.getText(findWindowsObject('General/curArreteDate')).split('/')
		KeywordUtil.logInfo("Getting the date..."+((((a[2]) + '-') + (a[1])) + '-') + (a[0]))
		return ((((a[2]) + '-') + (a[1])) + '-') + (a[0])
	}

	@Keyword
	String getEnv() {
		String env = Windows.getText(findWindowsObject('Common/env'))
		KeywordUtil.logInfo("Getting env..."+env)
		return env
	}

	@Keyword
	void screenshot(String name) {
		WindowsActionHelper.create(WindowsDriverFactory.getWindowsSession()).takeScreenshot(RunConfiguration.getReportFolder() +'\\Evidences\\' + name + '.PNG')
	}

	@Keyword
	void checkErrors(String errors) {
		if (errors != '') {
			KeywordUtil.markFailed('\n' + errors)
		}
	}

	void importFile(String fileName) {
		Export export = new Export()

		StringSelection stringSelection = new StringSelection(fileName)
		Toolkit.getDefaultToolkit().getSystemClipboard().setContents(stringSelection, null)
		Windows.delay(2)

		clickImageSafe(images.fileTopDialog, "fileTopDialog", 20)
	    export.simulateCtrlV()
	    Windows.delay(2)
	
	    clickImageSafe(imagesPassarele.passerelleBilanFile, "passerelleBilanFile", 20)
	    Windows.delay(2)
	
	    clickImageSafe(images.open, "openBtn", 20)
	}
	
	void clickImageSafe(String templatePath, String tag, int timeoutSec = 15) {
		
			long end = System.currentTimeMillis() + (timeoutSec * 1000)
			Exception last
		
			copyTemplateToReport(templatePath, "TEMPLATE_" + tag)
		
			while (System.currentTimeMillis() < end) {
				try {
					WindowsImageKeywords.clickImage(templatePath)
					return
				} catch (Exception e) {
					last = e
					Windows.delay(1)
				}
			}
		
			String shot = saveDebugScreenshot("IMG_NOT_FOUND_" + tag)
			KeywordUtil.logInfo("ðŸ“¸ Screenshot saved: " + shot)
		
			throw last ?: new Exception("Cannot recognise image on screen: " + templatePath)
	}
		
	String saveDebugScreenshot(String name) {
	    String folder = RunConfiguration.getReportFolder()
	    String path = folder + "/" + name + "_" + System.currentTimeMillis() + ".png"
	    Windows.takeScreenshot(path)
	    KeywordUtil.logInfo("ðŸ“¸ Screenshot saved: " + path)
	    return path
	}

		
	void copyTemplateToReport(String templatePath, String name) {
		try {
			String folder = RunConfiguration.getReportFolder()
			String out = folder + "/" + name + ".png"
			Files.copy(Paths.get(templatePath), Paths.get(out), StandardCopyOption.REPLACE_EXISTING)
			KeywordUtil.logInfo("ðŸ§© Template copied to: " + out)
		} catch (Exception e) {
			KeywordUtil.logInfo("ðŸ§© Could not copy template: " + e.getMessage())
		}
	}
